# ===== CONFIGURA√á√ÉO NGINX PARA VPS COMPARTILHADA =====
# Arquivo: /etc/nginx/sites-available/multiprojetos
#
# Para usar:
# 1. Copie este conte√∫do para /etc/nginx/sites-available/multiprojetos
# 2. Execute: sudo ln -s /etc/nginx/sites-available/multiprojetos /etc/nginx/sites-enabled/
# 3. Execute: sudo nginx -t && sudo systemctl reload nginx

server {
    listen 80;
    server_name 69.62.90.202 voluntarios.mathaus.dev;

    # Logs gerais do servidor
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;

    # Configura√ß√µes gerais de seguran√ßa
    add_header X-Content-Type-Options nosniff;
    add_header X-Frame-Options DENY;
    add_header X-XSS-Protection "1; mode=block";

    # =============================================================
    # PROJETO DUNAMYS - PORTA 8080
    # =============================================================
    location /dunamys {
        # Remove /dunamys do path
        rewrite ^/dunamys/?(.*)$ /$1 break;

        proxy_pass http://127.0.0.1:8080;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;

        # Timeouts
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # Acesso direto por porta (alternativa)
    location ~ ^/dunamys:8080(.*)$ {
        return 301 /dunamys$1;
    }

    # =============================================================
    # PROJETO ZOLPIA - PORTA 8700
    # =============================================================
    location /zolpia {
        # Remove /zolpia do path
        rewrite ^/zolpia/?(.*)$ /$1 break;

        proxy_pass http://127.0.0.1:8700;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;

        # Timeouts espec√≠ficos para API
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # =============================================================
    # RESERVADO PARA FUTUROS PROJETOS
    # =============================================================
    # location /projeto3 {
    #     rewrite ^/projeto3/?(.*)$ /$1 break;
    #     proxy_pass http://127.0.0.1:8081;
    #     # ... outras configura√ß√µes
    # }

    # =============================================================
    # P√ÅGINA INICIAL - DASHBOARD DOS PROJETOS
    # =============================================================
    location = / {
        return 200 '
        <!DOCTYPE html>
        <html>
        <head>
            <title>VPS Projects Dashboard</title>
            <meta charset="UTF-8">
            <style>
                body { font-family: Arial, sans-serif; margin: 40px; background: #f5f5f5; }
                .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 8px; }
                h1 { color: #333; text-align: center; }
                .project { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 5px; }
                .project h3 { margin-top: 0; color: #0066cc; }
                .project a { color: #0066cc; text-decoration: none; font-weight: bold; }
                .project a:hover { text-decoration: underline; }
                .status { display: inline-block; padding: 3px 8px; border-radius: 3px; color: white; font-size: 12px; }
                .status.online { background: #28a745; }
                .status.offline { background: #dc3545; }
            </style>
        </head>
        <body>
            <div class="container">
                <h1>üöÄ VPS Projects Dashboard</h1>
                <p>Servidor: <strong>69.62.90.202</strong></p>

                <div class="project">
                    <h3>üìä Dunamys - Sistema de Volunt√°rios da Igreja</h3>
                    <p><strong>Porta:</strong> 8080 | <strong>Status:</strong> <span class="status online">ONLINE</span></p>
                    <p><strong>Descri√ß√£o:</strong> Sistema de gerenciamento de volunt√°rios e escalas da igreja</p>
                    <p><strong>Acessar:</strong> <a href="/dunamys">69.62.90.202/dunamys</a></p>
                </div>

                <div class="project">
                    <h3>ü©∫ Zolpia - Sistema de An√°lise de Receitas</h3>
                    <p><strong>Porta:</strong> 8700 | <strong>Status:</strong> <span class="status online">ONLINE</span></p>
                    <p><strong>Descri√ß√£o:</strong> Sistema de OCR e an√°lise de receitas farmac√™uticas</p>
                    <p><strong>Acessar:</strong> <a href="/zolpia">69.62.90.202/zolpia</a></p>
                </div>

                <div class="project">
                    <h3>üîß Slot Dispon√≠vel</h3>
                    <p><strong>Porta:</strong> 8081 | <strong>Status:</strong> <span class="status offline">DISPON√çVEL</span></p>
                    <p><strong>Descri√ß√£o:</strong> Espa√ßo reservado para pr√≥ximo projeto</p>
                </div>
            </div>
        </body>
        </html>';
        add_header Content-Type text/html;
    }

    # =============================================================
    # CONFIGURA√á√ïES DE CACHE E OTIMIZA√á√ÉO
    # =============================================================
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        add_header Vary Accept-Encoding;

        # Try to proxy to the appropriate service based on referer
        set $upstream "";
        if ($http_referer ~* "/dunamys") {
            set $upstream "http://127.0.0.1:8080";
        }
        if ($http_referer ~* "/zolpia") {
            set $upstream "http://127.0.0.1:8700";
        }

        # Fallback to dunamys if no referer match
        if ($upstream = "") {
            set $upstream "http://127.0.0.1:8080";
        }

        proxy_pass $upstream;
        proxy_set_header Host $host;
    }

    # =============================================================
    # CONFIGURA√á√ïES DE SEGURAN√áA
    # =============================================================
    # Bloquear acesso a arquivos sens√≠veis
    location ~ /\.(?!well-known).* {
        deny all;
        access_log off;
        log_not_found off;
    }

    # Bloquear acesso a arquivos de configura√ß√£o
    location ~ /\.(env|git|svn|htaccess|htpasswd) {
        deny all;
        access_log off;
        log_not_found off;
    }

    # Health check endpoint para monitoramento
    location /health {
        return 200 '{"status":"ok","server":"69.62.90.202","timestamp":"$(date)"}';
        add_header Content-Type application/json;
        access_log off;
    }
}

# =============================================================
# RATE LIMITING (adicionar no bloco http do nginx.conf principal)
# =============================================================
# limit_req_zone $binary_remote_addr zone=api:10m rate=30r/m;
# limit_req_zone $binary_remote_addr zone=auth:10m rate=10r/m;

# Aplicar rate limiting espec√≠fico para autentica√ß√£o
# location ~ ^/(dunamys|zolpia)/api/auth {
#     limit_req zone=auth burst=5 nodelay;
#     # ... resto da configura√ß√£o de proxy
# }